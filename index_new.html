<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Умный дом</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #f3f7fb;
      transition: background 0.5s ease;
    }
    body.night {
      background: #0b1220;
    }
    .room {
      position: relative;
      z-index: 0;
    }
    .window {
      position: relative;
      z-index: 5;
      overflow: hidden;
    }
    /* Городской пейзаж */
    .city-scape {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
      z-index: 0;
    }
    /* Солнце */
    .sun {
      position: absolute;
      left: 70%;
      top: 20%;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, #fff59d, #ffcc33 40%, transparent 60%);
      box-shadow: 0 0 40px 5px rgba(255, 204, 51, 0.4);
      z-index: 2;
      transition: opacity 1s ease;
    }
    /* Здания */
    .building {
      position: absolute;
      bottom: 0;
      background: #888;
      border: 1px solid #666;
    }
    .building-1 {
      left: 10%;
      width: 60px;
      height: 100px;
      background: linear-gradient(to right, #777, #999);
    }
    .building-2 {
      left: 25%;
      width: 80px;
      height: 140px;
      background: linear-gradient(to right, #666, #888);
    }
    .building-3 {
      left: 50%;
      width: 50px;
      height: 80px;
      background: linear-gradient(to right, #888, #aaa);
    }
    /* Окна на зданиях */
    .window-light {
      position: absolute;
      background: #ffeb3b;
      border: 1px solid #ffc107;
    }
    /* Окна на первом здании */
    .building-1 .window-light:nth-child(1) {
      top: 20px;
      left: 10px;
      width: 10px;
      height: 15px;
    }
    .building-1 .window-light:nth-child(2) {
      top: 20px;
      right: 10px;
      width: 10px;
      height: 15px;
    }
    .building-1 .window-light:nth-child(3) {
      top: 50px;
      left: 10px;
      width: 10px;
      height: 15px;
    }
    .building-1 .window-light:nth-child(4) {
      top: 50px;
      right: 10px;
      width: 10px;
      height: 15px;
    }
    /* Окна на втором здании */
    .building-2 .window-light:nth-child(1) {
      top: 20px;
      left: 15px;
      width: 12px;
      height: 18px;
    }
    .building-2 .window-light:nth-child(2) {
      top: 20px;
      right: 15px;
      width: 12px;
      height: 18px;
    }
    .building-2 .window-light:nth-child(3) {
      top: 50px;
      left: 15px;
      width: 12px;
      height: 18px;
    }
    .building-2 .window-light:nth-child(4) {
      top: 50px;
      right: 15px;
      width: 12px;
      height: 18px;
    }
    .building-2 .window-light:nth-child(5) {
      top: 80px;
      left: 15px;
      width: 12px;
      height: 18px;
    }
    .building-2 .window-light:nth-child(6) {
      top: 80px;
      right: 15px;
      width: 12px;
      height: 18px;
    }
    /* Окна на третьем здании */
    .building-3 .window-light:nth-child(1) {
      top: 15px;
      left: 8px;
      width: 8px;
      height: 12px;
    }
    .building-3 .window-light:nth-child(2) {
      top: 15px;
      right: 8px;
      width: 8px;
      height: 12px;
    }
    .building-3 .window-light:nth-child(3) {
      top: 40px;
      left: 8px;
      width: 8px;
      height: 12px;
    }
    .building-3 .window-light:nth-child(4) {
      top: 40px;
      right: 8px;
      width: 8px;
      height: 12px;
    }
    .curtain {
      position: absolute;
      top: 0;
      width: 50%;
      height: 100%;
      background: linear-gradient(180deg, #b55 0%, #811 100%);
      box-shadow: inset -6px 0 16px rgba(0,0,0,0.25);
      transition: transform 1s cubic-bezier(.22,.9,.34,1);
      z-index: 3;
    }
    .curtain.left {
      left: 0;
      transform: translateX(0);
      transform-origin: left;
    }
    .curtain.right {
      right: 0;
      transform: translateX(0);
      transform-origin: right;
    }
    .curtain.open-left {
      transform: translateX(-110%);
    }
    .curtain.open-right {
      transform: translateX(110%);
    }
    /* Стили для люстры */
    .chandelier {
      position: absolute;
      top: 0;
      left: 60%; /* Переместили правее */
      transform: translateX(-50%);
      width: 200px;
      height: 100px;
      z-index: 25;
    }
    .chandelier-chain {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 20px;
      background: #555;
    }
    .chandelier-base {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 12px;
      background: linear-gradient(to bottom, #444, #222);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    /* Улучшенная люстра */
    .chandelier-body {
      position: absolute;
      top: 32px;
      left: 50%;
      transform: translateX(-50%);
      width: 90px;
      height: 50px;
      background: radial-gradient(ellipse at center, #333 0%, #111 100%);
      border-radius: 50% 50% 40% 40%;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
    }
    /* Декоративные элементы люстры */
    .chandelier-decor {
      position: absolute;
      top: 35px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 8px;
      background: linear-gradient(to right, transparent, #666, transparent);
      border-radius: 4px;
    }
    .chandelier-arm {
      position: absolute;
      top: 50px;
      width: 60px;
      height: 3px;
      background: linear-gradient(to right, #555, #333);
      border-radius: 2px;
    }
    .chandelier-arm.left {
      left: 20px;
      transform: rotate(-35deg);
      transform-origin: left top;
    }
    .chandelier-arm.right {
      right: 20px;
      transform: rotate(35deg);
      transform-origin: right top;
    }
    .chandelier-holder {
      position: absolute;
      width: 8px;
      height: 15px;
      background: linear-gradient(to bottom, #666, #444);
      border-radius: 0 0 4px 4px;
    }
    .chandelier-holder.left {
      top: 55px;
      left: 10px;
      transform: rotate(-35deg);
    }
    .chandelier-holder.right {
      top: 55px;
      right: 10px;
      transform: rotate(35deg);
    }
    .chandelier-holder.center {
      top: 65px;
      left: 50%;
      transform: translateX(-50%);
    }
    .chandelier-chain-small {
      position: absolute;
      width: 1px;
      background: #777;
    }
    .chandelier-chain-small.left {
      top: 55px;
      left: 14px;
      height: 12px;
      transform: rotate(-35deg);
    }
    .chandelier-chain-small.right {
      top: 55px;
      right: 14px;
      height: 12px;
      transform: rotate(35deg);
    }
    .chandelier-chain-small.center {
      top: 65px;
      left: 50%;
      transform: translateX(-50%);
      height: 15px;
    }
    .chandelier-bulb {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #2f2f2f;
      box-shadow: inset -4px -4px 8px rgba(255,255,255,0.03);
      transition: all 450ms ease;
      z-index: 30;
    }
    .chandelier-bulb.left {
      top: 65px;
      left: 12px;
    }
    .chandelier-bulb.right {
      top: 65px;
      right: 11px;
    }
    .chandelier-bulb.center {
      top: 78px;
      left: 50%;
      transform: translateX(-50%);
    }
    .chandelier-bulb.on {
      background: radial-gradient(circle at 35% 30%, #fff9d6, #ffd54d 40%, #ffb300 60%);
      box-shadow: 0 0 25px 5px rgba(255,200,60,0.3);
      transform: scale(1.1);
    }
    /* Свечения для лампочек */
    .chandelier-glow {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      opacity: 0;
      filter: blur(15px);
      transition: opacity 400ms ease;
      pointer-events: none;
      background: radial-gradient(circle at 50% 30%, rgba(255,235,140,0.8), rgba(255,200,60,0.1) 60%);
      z-index: 24;
    }
    .chandelier-glow.left {
      top: 65px;
      left: 12px;
      transform: translate(-50%, -50%);
    }
    .chandelier-glow.right {
      top: 65px;
      right: 11px;
      transform: translate(50%, -50%);
    }
    .chandelier-glow.center {
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      width: 220px;
      height: 120px;
      filter: blur(20px);
    }
    .chandelier-glow.on {
      opacity: 1;
    }
    .tv-container {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        width: 256px;
        height: 144px;
        z-index: 15;
    }
    .tv {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 100%;
    }
    .tv-off {
      background: linear-gradient(180deg,#2b2b2b,#111);
      color: #8a8a8a;
    }
    .tv-on {
      background: linear-gradient(180deg,#0b3 10%, #036 90%);
      color: white;
    }
    .tv-screen {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .tv-on .tv-screen {
      display: block;
    }
    .tv-on .screen-text {
      display: none;
    }
    .tv-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 10px solid #000;
      box-sizing: border-box;
      pointer-events: none;
    }
    .tv-stand {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 350px;
      height: 53px;
      background: linear-gradient(180deg, #8B4513, #A0522D, #8B4513);
      border-radius: 8px;
      z-index: 1;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .tv-stand-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 30px;
        background: linear-gradient(180deg, #5D2906, #7B3F09);
        border-radius: 8px 8px 0 0;
        box-shadow: inset 0 -2px 4px rgba(0,0,0,0.2);
    }
    .tv-stand-boards {
        position: absolute;
        top: 2px;
        left: 5px;
        right: 5px;
        height: 26px;
        display: flex;
        justify-content: space-between;
    }
    .tv-stand-board {
        width: calc(33% - 4px);
        height: 100%;
        background: linear-gradient(180deg, #7B3F09, #5D2906);
        border-radius: 2px;
    }
    .tv-stand-base {
        position: absolute;
        top: 30px;
        left: 15px;
        right: 15px;
        bottom: 10px;
        background: linear-gradient(180deg, #A0522D, #CD853F);
        border-radius: 4px;
        box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
    }
    .digital-clock {
      position: absolute;
      top: -35px;
      right: 30px;
      width: 100px;
      height: 50px;
      background: #111;
      border-radius: 6px;
      border: 2px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      transition: opacity 0.3s ease;
    }
    .time-display {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      color: #0f0;
      text-shadow: 0 0 8px rgba(0, 255, 0, 0.7);
      letter-spacing: 1px;
    }
    /* Стили для вкладок */
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1rem;
      width: 100%; /* Исправлено: ширина теперь соответствует контейнеру */
    }
    .tab-button {
      flex: 1;
      padding: 0.5rem;
      background-color: #f3f4f6;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .tab-button.active {
      background-color: white;
      font-weight: 600;
      border-bottom: 2px solid #3b82f6;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Стили для кнопки микрофона */
    .mic-button {
      width: 150px; /* Увеличение ширины в 1.5 раза */
      height: 150px; /* Увеличение высоты в 1.5 раза */
      background-color: #e5e7eb;
      border: 2px solid #d1d5db;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      margin: 2rem auto;
      position: relative;
    }
    .mic-button:hover {
      background-color: #d1d5db;
    }
    .mic-button:active, .mic-button.listening {
      background-color: #9ca3af;
      transform: scale(0.98);
    }
    .mic-icon {
      width: 40px;
      height: 40px;
      fill: #4b5563;
    }
    /* Анимация записи */
    .recording-dot {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      background-color: #ef4444;
      border-radius: 50%;
      display: none;
    }
    .mic-button.listening .recording-dot {
      display: block;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }
    /* Полоска частот */
    .frequency-bar {
      height: 4px;
      background: linear-gradient(to right, #3b82f6, #8b5cf6, #ec4899);
      border-radius: 2px;
      margin: 10px 0;
      width: 0%;
      transition: width 0.1s ease;
    }
    /* Стили для сценариев */
    .scenario-section {
      margin-top: 1rem;
    }
    .scenario-form {
      padding: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      background-color: #f9fafb;
      margin-bottom: 1rem;
    }
    .device-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
    }
    .scenario-list {
      margin-top: 1rem;
    }
    .scenario-item {
      padding: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .scenario-item button {
      margin-left: 0.5rem;
    }
    @media (max-width: 768px) {
      .room {
        height: 360px;
      }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-4 gap-6">
    <aside class="md:col-span-1 bg-white/80 dark:bg-gray-900/60 backdrop-blur rounded-2xl p-5 shadow-lg">
      <h2 class="text-xl font-semibold mb-3">Smart Home Controls</h2>
      <!-- Вкладки (поменяли местами) -->
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="voice">Голосовой ввод</button>
        <button class="tab-button" data-tab="buttons">Кнопки</button>
        <button class="tab-button" data-tab="scenarios">Сценарии</button> <!-- Новая вкладка -->
      </div>
      <!-- Содержимое вкладок -->
      <div class="tab-content active" id="tab-voice-content">
        <div class="flex flex-col items-center">
          <div id="mic-button" class="mic-button">
            <div class="recording-dot"></div>
            <svg class="mic-icon" viewBox="0 0 24 24">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.42 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.3 6-6.72h-1.7z"/>
            </svg>
          </div>
          <p class="text-gray-500 text-sm mt-2">Нажмите для записи</p>
          <div id="voice-status" class="text-sm mt-2 text-center h-6"></div>
          <!-- Полоска частот -->
          <div id="frequency-bar" class="frequency-bar w-full max-w-xs"></div>
        </div>
      </div>
      <div class="tab-content" id="tab-buttons-content">
        <div class="space-y-3">
          <button id="btn-curtains" class="w-full py-2 rounded-lg border hover:scale-[1.01] transition-transform">
            Закрыть шторы
          </button>
          <button id="btn-lights" class="w-full py-2 rounded-lg border hover:scale-[1.01] transition-transform">
            Включить свет
          </button>
          <button id="btn-tv" class="w-full py-2 rounded-lg border hover:scale-[1.01] transition-transform">
            Включить ТВ
          </button>
          <!-- Кнопка для выключения часов -->
          <button id="btn-clock" class="w-full py-2 rounded-lg border hover:scale-[1.01] transition-transform">
            Выключить часы
          </button>
          <!-- Кнопка для отображения погоды -->
          <button id="btn-weather" class="w-full py-2 rounded-lg border hover:scale-[1.01] transition-transform">
            Показать погоду
          </button>
          <div class="flex gap-2 mt-2">
            <button id="btn-morning" class="flex-1 py-2 rounded-lg bg-yellow-400 hover:opacity-90">
              Утро
            </button>
            <button id="btn-evening" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white hover:opacity-90">
              Вечер
            </button>
          </div>
          <!-- Кнопка для открытия сценариев - теперь вкладка -->
          <!-- <button id="btn-scenarios" class="w-full py-2 rounded-lg border hover:scale-[1.01] transition-transform mt-4">
            Сценарии
          </button> -->
        </div>
        <!-- Панель сценариев - теперь таб-контент -->
        <!-- <div id="scenario-panel" class="scenario-section hidden"> -->
      </div>
      <div class="tab-content" id="tab-scenarios-content"> <!-- Новый таб-контент -->
        <div class="scenario-section">
          <h3 class="text-lg font-medium mb-2">Сценарии</h3>
          <div class="scenario-form">
            <input type="text" id="scenario-name" placeholder="Название сценария" class="w-full p-2 mb-2 border rounded">
            <div class="space-y-2 mb-2">
              <div class="device-option">
                <label>Шторы</label>
                <select id="device-curtains" class="border rounded p-1">
                  <option value="open">Открыть</option>
                  <option value="close">Закрыть</option>
                </select>
              </div>
              <div class="device-option">
                <label>Свет</label>
                <select id="device-lights" class="border rounded p-1">
                  <option value="on">Включить</option>
                  <option value="off">Выключить</option>
                </select>
              </div>
              <div class="device-option">
                <label>ТВ</label>
                <select id="device-tv" class="border rounded p-1">
                  <option value="on">Включить</option>
                  <option value="off">Выключить</option>
                </select>
              </div>
              <div class="device-option">
                <label>Часы</label>
                <select id="device-clock" class="border rounded p-1">
                  <option value="on">Включить</option>
                  <option value="off">Выключить</option>
                </select>
              </div>
              <div class="device-option">
                <label>Погода</label>
                <select id="device-weather" class="border rounded p-1">
                  <option value="show">Показать</option>
                  <option value="hide">Скрыть</option>
                </select>
              </div>
            </div>
            <button id="save-scenario" class="w-full py-2 bg-blue-500 text-white rounded-lg hover:opacity-90">Сохранить</button>
          </div>
          <!-- Список сценариев -->
          <div id="scenario-list" class="scenario-list">
            <h4 class="text-md font-medium mb-1">Сохранённые сценарии</h4>
            <!-- Элементы списка будут добавляться сюда -->
          </div>
        </div>
      </div>
    </aside>
    <main class="md:col-span-2 bg-gradient-to-b from-white/60 to-transparent rounded-2xl p-6 relative overflow-hidden shadow-xl">
      <!-- Панель погоды -->
      <div id="weather-panel" class="absolute top-4 right-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl p-3 z-50 hidden w-48">
        <div class="text-center">
          <div class="text-lg font-semibold">Сургут</div>
          <div class="text-xl font-bold mt-1">Солнечно</div>
          <div class="text-xl mt-1">+15°</div>
        </div>
      </div>
      <div class="flex items-start gap-6">
        <div class="flex-1">
          <div id="room" class="room relative rounded-xl p-6 h-[420px] transition-all duration-700 bg-[#eaf2ff] text-black">
            <!-- Окно с городским пейзажем -->
            <div class="window absolute left-12 top-12 w-72 h-52 bg-gradient-to-b from-sky-200 to-white rounded-lg shadow-inner overflow-hidden">
              <!-- Городской пейзаж -->
              <div class="city-scape">
                <div class="sun"></div>
                <div class="building building-1">
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                </div>
                <div class="building building-2">
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                </div>
                <div class="building building-3">
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                  <div class="window-light"></div>
                </div>
              </div>
              <div class="curtain left open-left"></div>
              <div class="curtain right open-right"></div>
            </div>
            <!-- Люстра -->
            <div class="chandelier">
              <div class="chandelier-chain"></div>
              <div class="chandelier-base"></div>
              <div class="chandelier-body"></div>
              <div class="chandelier-decor"></div>
              <div class="chandelier-arm left"></div>
              <div class="chandelier-arm right"></div>
              <div class="chandelier-holder left"></div>
              <div class="chandelier-holder right"></div>
              <div class="chandelier-holder center"></div>
              <div class="chandelier-chain-small left"></div>
              <div class="chandelier-chain-small right"></div>
              <div class="chandelier-chain-small center"></div>
              <div class="chandelier-bulb left"></div>
              <div class="chandelier-bulb right"></div>
              <div class="chandelier-bulb center"></div>
              <!-- Свечения для всех лампочек -->
              <div class="chandelier-glow left"></div>
              <div class="chandelier-glow right"></div>
              <div class="chandelier-glow center"></div>
            </div>
            <div class="tv-container">
                <div class="tv tv-off">
                    <div class="tv-frame"></div>
                    <img src="https://cdn.maximonline.ru/91/26/c4/9126c445ee6e097754b5fdf471e47874/416x257_0xac120005_2938080411529046295.gif    " alt="TV Screen" class="tv-screen">
                    <div class="screen-text flex items-center justify-center text-sm font-medium h-full">ТВ — выкл.</div>
                </div>
                <div class="tv-stand">
                    <div class="tv-stand-top">
                        <div class="tv-stand-boards">
                            <div class="tv-stand-board"></div>
                            <div class="tv-stand-board"></div>
                            <div class="tv-stand-board"></div>
                        </div>
                    </div>
                    <div class="tv-stand-base"></div>
                    <!-- Цифровые часы справа на столике -->
                    <div class="digital-clock">
                        <div class="time-display" id="time-display">00:00:00</div>
                    </div>
                </div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-2">
            <div id="status-curtains" class="p-3 rounded-lg bg-white/70 dark:bg-gray-800/60">Шторы: Открыты</div>
            <div id="status-lights" class="p-3 rounded-lg bg-white/70 dark:bg-gray-800/60">Свет: Выключен</div>
            <div id="status-tv" class="p-3 rounded-lg bg-white/70 dark:bg-gray-800/60">ТВ: Выкл.</div>
            <div id="status-clock" class="p-3 rounded-lg bg-white/70 dark:bg-gray-800/60">Часы: Работают</div>
          </div>
        </div>
      </div>
    </main>
    <aside class="md:col-span-1 bg-white/80 dark:bg-gray-900/60 backdrop-blur rounded-2xl p-5 shadow-lg">
      <h2 class="text-xl font-semibold mb-3">История запросов</h2>
      <ul id="history-list" class="space-y-2 h-[500px] overflow-y-auto"> <!-- Изменена высота -->
        <!-- Записи истории будут добавляться сюда -->
        <li class="text-gray-500 text-sm italic">История пуста</li>
      </ul>
    </aside>
  </div>
  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    // Логика переключения вкладок
    const tabButtons = $$('.tab-button');
    const tabContents = $$('.tab-content');
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');
        // Убираем активный класс у всех кнопок и контентов
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        // Добавляем активный класс текущей кнопке и контенту
        button.classList.add('active');
        $(`#tab-${tabName}-content`).classList.add('active');
      });
    });
    // Логика кнопки микрофона
    const micButton = $('#mic-button');
    const voiceStatus = $('#voice-status');
    const frequencyBar = $('#frequency-bar');
    let isListening = false;
    let recordingInterval = null;
    let frequencyInterval = null;
    let mediaRecorder = null;
    let audioChunks = [];
    // При загрузке страницы открываем вкладку голосового ввода
    window.addEventListener('DOMContentLoaded', () => {
      // Активируем вкладку голосового ввода
      const voiceTabButton = $('.tab-button[data-tab="voice"]');
      const buttonsTabButton = $('.tab-button[data-tab="buttons"]');
      const scenariosTabButton = $('.tab-button[data-tab="scenarios"]'); // Новая кнопка
      const voiceTabContent = $('#tab-voice-content');
      const buttonsTabContent = $('#tab-buttons-content');
      const scenariosTabContent = $('#tab-scenarios-content'); // Новый контент
      // Убираем активный класс у кнопок и контентов
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      // Добавляем активный класс голосовому вводу
      voiceTabButton.classList.add('active');
      voiceTabContent.classList.add('active');
    });
    // Функция для запроса доступа к микрофону
    async function requestMicrophoneAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        voiceStatus.textContent = 'Готов к записи';
        return stream;
      } catch (err) {
        console.error('Ошибка доступа к микрофону:', err);
        voiceStatus.textContent = 'Нет доступа к микрофону';
        return null;
      }
    }
    // Функция для имитации полоски частот
    function startFrequencySimulation() {
      frequencyInterval = setInterval(() => {
        const width = Math.floor(Math.random() * 100);
        frequencyBar.style.width = `${width}%`;
      }, 100);
    }
    // Функция для остановки имитации полоски частот
    function stopFrequencySimulation() {
      clearInterval(frequencyInterval);
      frequencyBar.style.width = '0%';
    }
    // --- Новая логика для истории запросов ---
    const historyList = $('#history-list');
    // Загрузка истории из localStorage
    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('smartHomeHistory') || '[]');
        renderHistory(history);
        return history;
    }
    // Сохранение истории в localStorage
    function saveHistory(history) {
        localStorage.setItem('smartHomeHistory', JSON.stringify(history));
    }
    // Отображение истории
    function renderHistory(history) {
        if (history.length === 0) {
            historyList.innerHTML = '<li class="text-gray-500 text-sm italic">История пуста</li>';
            return;
        }
        historyList.innerHTML = '';
        history.slice().reverse().forEach(item => {
            const li = document.createElement('li');
            li.className = 'p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm break-words';
            li.textContent = `${item.timestamp}: ${item.command}`;
            historyList.appendChild(li);
        });
    }
    // Добавление новой команды в историю
    function addToHistory(command) {
        const history = loadHistory();
        const now = new Date();
        const timestamp = now.toLocaleTimeString('ru-RU');
        history.push({ command, timestamp });
        // Ограничиваем историю 20 элементами
        if (history.length > 20) history.shift();
        saveHistory(history);
        renderHistory(history);
    }
    // --- Логика для отображения погоды ---
    const weatherPanel = $('#weather-panel');
    const btnWeather = $('#btn-weather');
    btnWeather.addEventListener('click', () => {
        weatherPanel.classList.remove('hidden');
        addToHistory("Погода: Сургут, Солнечно, +15°C"); // Добавляем в историю
        // Автоматически скрываем панель через 5 секунд
        setTimeout(() => {
            weatherPanel.classList.add('hidden');
        }, 5000);
    });
    // --- Обновленная логика кнопки микрофона ---
    // --- Обновленная логика кнопки микрофона ---
if (micButton) {
    micButton.addEventListener('click', async () => {
        if (!isListening) {
            // Начинаем запись
            isListening = true;
            micButton.classList.add('listening');
            voiceStatus.textContent = 'Запись...';

            // Запрашиваем доступ к микрофону
            const stream = await requestMicrophoneAccess();
            if (stream) {
                audioChunks = []; // Очищаем предыдущие фрагменты

                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    // Останавливаем все треки потока
                    stream.getTracks().forEach(track => track.stop());

                    // Собираем аудио в Blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append('file', audioBlob, 'recording.webm');

                    try {
                        voiceStatus.textContent = 'Обработка запроса...';
                        const response = await fetch('/transcribe/', {
                            method: 'POST',
                            body: formData,
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('Ответ от сервера:', data);
                        const classification = data.transcribed_text; // Получаем строку из candidate_labels

                        // --- Анализируем результат и вызываем действия ---
                        let executedAction = false;
                        let actionDescription = '';

                        switch (classification) {
                            case 'шторы':
                                btnCurtains.click(); // Используем существующую логику кнопки
                                actionDescription = curtainsOpen ? "Шторы открыты" : "Шторы закрыты";
                                executedAction = true;
                                break;
                            case 'свет':
                                btnLights.click(); // Используем существующую логику кнопки
                                actionDescription = lightsOn ? "Свет включён" : "Свет выключен";
                                executedAction = true;
                                break;
                            case 'телевизор':
                                btnTv.click(); // Используем существующую логику кнопки
                                actionDescription = tvOn ? "ТВ включён" : "ТВ выключен";
                                executedAction = true;
                                break;
                            case 'часы':
                                btnClock.click(); // Используем существующую логику кнопки
                                actionDescription = clockOn ? "Часы выключены" : "Часы включены";
                                executedAction = true;
                                break;
                            case 'утро':
                                btnMorning.click(); // Используем существующую логику кнопки
                                actionDescription = "Утренний режим активирован";
                                executedAction = true;
                                break;
                            case 'вечер':
                                btnEvening.click(); // Используем существующую логику кнопки
                                actionDescription = "Вечерний режим активирован";
                                executedAction = true;
                                break;
                            case 'погода':
                                btnWeather.click(); // Используем существующую логику кнопки
                                actionDescription = "Погода: Сургут, Солнечно, +15°C"; // Используем текст из существующего обработчика
                                executedAction = true;
                                break;
                            default:
                                // Если classification не совпадает ни с одним из кандидатов (маловероятно, но на всякий случай)
                                console.warn("Неожиданная метка классификации:", classification);
                                voiceStatus.textContent = 'Команда не распознана';
                                addToHistory(`Голосовая команда (не распознана): "${classification}"`);
                                return; // Выходим из onstop
                        }

                        if (executedAction) {
                            addToHistory(actionDescription);
                            voiceStatus.textContent = 'Команда выполнена';
                        }
                        // --- Конец анализа ---

                    } catch (error) {
                        console.error('Ошибка при отправке аудио или получении ответа:', error);
                        voiceStatus.textContent = 'Ошибка при обработке команды';
                        addToHistory(`Ошибка голосового ввода: ${error.message}`);
                    }
                };

                // Запускаем запись
                mediaRecorder.start();
                let seconds = 0;
                recordingInterval = setInterval(() => {
                    seconds++;
                    voiceStatus.textContent = `Запись... ${seconds}с`;
                    if (seconds >= 5) {
                        mediaRecorder.stop();
                        clearInterval(recordingInterval);
                    }
                }, 1000);

                startFrequencySimulation();

            } else {
                isListening = false;
                micButton.classList.remove('listening');
                voiceStatus.textContent = 'Ошибка доступа к микрофону';
                setTimeout(() => {
                    voiceStatus.textContent = '';
                }, 3000);
            }
        } else {
            // Останавливаем запись
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                stopFrequencySimulation();
            }
            // Состояние isListening будет установлено в false в onstop коллбэке
        }
    });
    }
    // --- Обновленная логика кнопок ---
    const btnCurtains = $('#btn-curtains');
    const btnLights = $('#btn-lights');
    const btnTv = $('#btn-tv');
    const btnMorning = $('#btn-morning');
    const btnEvening = $('#btn-evening');
    // Удалены несуществующие элементы
    const room = $('#room');
    const sun = $('.sun');
    const curtainLeft = $('.curtain.left');
    const curtainRight = $('.curtain.right');
    // Элементы люстры
    const chandelierBulbs = $$('.chandelier-bulb');
    // Все элементы свечения
    const chandelierGlows = $$('.chandelier-glow');
    const tv = $('.tv');
    const timeDisplay = $('#time-display');
    const statusCurtains = $('#status-curtains');
    const statusLights = $('#status-lights');
    const statusTv = $('#status-tv');
    const statusClock = $('#status-clock');
    // Изначально шторы открыты
    let curtainsOpen = true;
    let lightsOn = false;
    let tvOn = false;
    let theme = 'day';
    let soundEnabled = true;
    // Новое состояние для часов
    let clockOn = true;
    let clockInterval = null;
    function playSound(src) {
      if (!soundEnabled) return;
      try {
        const audio = new Audio(src);
        audio.volume = 0.6;
        audio.play().catch(() => {});
      } catch (e) {
        console.warn('Audio error', e);
      }
    }
    function updateClock() {
      if (!clockOn) return; // Не обновляем, если часы выключены
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      timeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
    }
    // Функция для запуска/остановки часов
    function toggleClock() {
        clockOn = !clockOn;
        if (clockOn) {
            // Включаем часы
            const btnClock = $('#btn-clock');
            if (btnClock) btnClock.textContent = 'Выключить часы';
            timeDisplay.style.opacity = "1";
            clockInterval = setInterval(updateClock, 1000);
            statusClock.textContent = `Часы: Работают`;
            addToHistory("Часы включены"); // Добавляем в историю
        } else {
            // Выключаем часы
            const btnClock = $('#btn-clock');
            if (btnClock) btnClock.textContent = 'Включить часы';
            timeDisplay.style.opacity = "0.3";
            clearInterval(clockInterval);
            statusClock.textContent = `Часы: Выключены`;
            addToHistory("Часы выключены"); // Добавляем в историю
        }
    }
    function updateUI() {
      const btnCurtains = $('#btn-curtains');
      const btnLights = $('#btn-lights');
      const btnTv = $('#btn-tv');
      if (btnCurtains) btnCurtains.textContent = curtainsOpen ? 'Закрыть шторы' : 'Открыть шторы';
      if (btnLights) btnLights.textContent = lightsOn ? 'Выключить свет' : 'Включить свет';
      if (btnTv) btnTv.textContent = tvOn ? 'Выключить ТВ' : 'Включить ТВ';
      // Состояние часов обновляется в toggleClock
      curtainLeft.classList.toggle('open-left', curtainsOpen);
      curtainRight.classList.toggle('open-right', curtainsOpen);
      if (sun) sun.style.opacity = curtainsOpen ? '1' : '0.3';
      // Управление люстрой
      chandelierBulbs.forEach(bulb => {
        bulb.classList.toggle('on', lightsOn);
      });
      // Управление свечением всех лампочек
      chandelierGlows.forEach(glow => {
        glow.classList.toggle('on', lightsOn);
      });
      tv.classList.toggle('tv-on', tvOn);
      tv.classList.toggle('tv-off', !tvOn);
      const screenText = $('.tv .screen-text');
      if (screenText) {
          if (tvOn) {
            screenText.textContent = '';
          } else {
            screenText.textContent = 'ТВ — выкл.';
          }
      }
      if (statusCurtains) statusCurtains.textContent = `Шторы: ${curtainsOpen ? 'Открыты' : 'Закрыты'}`;
      if (statusLights) statusLights.textContent = `Свет: ${lightsOn ? 'Включён' : 'Выключен'}`;
      if (statusTv) statusTv.textContent = `ТВ: ${tvOn ? 'Вкл.' : 'Выкл.'}`;
      // Статус часов обновляется в toggleClock
    }
    // Проверяем существование элементов перед добавлением обработчиков
    if (btnCurtains) {
      btnCurtains.addEventListener('click', () => {
        curtainsOpen = !curtainsOpen;
        if (!curtainsOpen) {
          document.body.classList.add('night');
          if (room) {
              room.classList.remove('bg-[#eaf2ff]', 'text-black');
              room.classList.add('bg-[#0b1320]', 'text-white');
          }
        } else {
          if (!lightsOn) {
            document.body.classList.remove('night');
            if (room) {
                room.classList.remove('bg-[#0b1320]', 'text-white');
                room.classList.add('bg-[#eaf2ff]', 'text-black');
            }
          }
        }
        playSound(curtainsOpen ? '/sounds/curtain-open.mp3' : '/sounds/curtain-close.mp3');
        updateUI();
        addToHistory(curtainsOpen ? "Шторы открыты" : "Шторы закрыты"); // Добавляем в историю
      });
    }
    if (btnLights) {
      btnLights.addEventListener('click', () => {
        lightsOn = !lightsOn;
        if (lightsOn) {
          document.body.classList.remove('night');
          if (room) {
              room.classList.remove('bg-[#0b1320]', 'text-white');
              room.classList.add('bg-[#eaf2ff]', 'text-black');
          }
        }
        else if (!curtainsOpen) {
           document.body.classList.add('night');
           if (room) {
               room.classList.remove('bg-[#eaf2ff]', 'text-black');
               room.classList.add('bg-[#0b1320]', 'text-white');
           }
        }
        playSound('/sounds/switch.mp3');
        updateUI();
        addToHistory(lightsOn ? "Свет включён" : "Свет выключен"); // Добавляем в историю
      });
    }
    if (btnTv) {
      btnTv.addEventListener('click', () => {
        tvOn = !tvOn;
        playSound('/sounds/tv-toggle.mp3');
        updateUI();
        addToHistory(tvOn ? "ТВ включён" : "ТВ выключен"); // Добавляем в историю
      });
    }
    // Обработчик для кнопки выключения часов
    const btnClock = $('#btn-clock');
    if (btnClock) {
      btnClock.addEventListener('click', () => {
          toggleClock();
          // playSound('/sounds/switch.mp3'); // Можно добавить звук
      });
    }
    if (btnMorning) {
      btnMorning.addEventListener('click', () => {
        curtainsOpen = true;
        lightsOn = false;
        tvOn = false;
        // При утреннем режиме включаем часы
        if (!clockOn) toggleClock();
        document.body.classList.remove('night');
        if (room) {
            room.classList.remove('bg-[#0b1320]', 'text-white');
            room.classList.add('bg-[#eaf2ff]', 'text-black');
        }
        playSound('/sounds/morning.mp3');
        updateUI();
        addToHistory("Утренний режим активирован"); // Добавляем в историю
      });
    }
    if (btnEvening) {
      btnEvening.addEventListener('click', () => {
        curtainsOpen = false;
        lightsOn = true;
        tvOn = true;
        // При вечернем режиме включаем часы
        if (!clockOn) toggleClock();
        document.body.classList.add('night');
        if (room) {
            room.classList.remove('bg-[#eaf2ff]', 'text-black');
            room.classList.add('bg-[#0b1320]', 'text-white');
        }
        playSound('/sounds/evening.mp3');
        updateUI();
        addToHistory("Вечерний режим активирован"); // Добавляем в историю
      });
    }
    // Инициализация часов
    updateClock();
    clockInterval = setInterval(updateClock, 1000);
    // Изначально шторы открыты
    updateUI();
    // --- Новая логика для сценариев ---
    // const btnScenarios = $('#btn-scenarios'); // Эта строка больше не нужна
    // const scenarioPanel = $('#scenario-panel'); // Эта строка больше не нужна
    const scenarioList = $('#scenario-list');
    const saveScenarioBtn = $('#save-scenario');
    // Загрузка сценариев из localStorage
    function loadScenarios() {
        const scenarios = JSON.parse(localStorage.getItem('smartHomeScenarios') || '[]');
        renderScenarioList(scenarios);
        return scenarios;
    }
    // Сохранение сценариев в localStorage
    function saveScenarios(scenarios) {
        localStorage.setItem('smartHomeScenarios', JSON.stringify(scenarios));
    }
    // Отображение списка сценариев
    function renderScenarioList(scenarios) {
        scenarioList.innerHTML = '<h4 class="text-md font-medium mb-1">Сохранённые сценарии</h4>';
        if (scenarios.length === 0) {
            scenarioList.innerHTML += '<p class="text-gray-500 text-sm italic">Сценарии отсутствуют</p>';
            return;
        }
        scenarios.forEach((scenario, index) => {
            const div = document.createElement('div');
            div.className = 'scenario-item';
            div.innerHTML = `
                <span>${scenario.name}</span>
                <button onclick="runScenario(${index})" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Запустить</button>
                <button onclick="deleteScenario(${index})" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Удалить</button>
            `;
            scenarioList.appendChild(div);
        });
    }
    // Функция запуска сценария
    function runScenario(index) {
        const scenarios = loadScenarios();
        const scenario = scenarios[index];
        if (scenario) {
            // Применяем изменения из сценария
            if (scenario.actions.curtains === 'open') {
                curtainsOpen = true;
                playSound('/sounds/curtain-open.mp3');
            } else if (scenario.actions.curtains === 'close') {
                curtainsOpen = false;
                playSound('/sounds/curtain-close.mp3');
            }
            if (scenario.actions.lights === 'on') {
                lightsOn = true;
                playSound('/sounds/switch.mp3');
            } else if (scenario.actions.lights === 'off') {
                lightsOn = false;
                playSound('/sounds/switch.mp3');
            }
            if (scenario.actions.tv === 'on') {
                tvOn = true;
                playSound('/sounds/tv-toggle.mp3');
            } else if (scenario.actions.tv === 'off') {
                tvOn = false;
                playSound('/sounds/tv-toggle.mp3');
            }
            if (scenario.actions.clock === 'on' && !clockOn) {
                toggleClock();
            } else if (scenario.actions.clock === 'off' && clockOn) {
                toggleClock();
            }
            if (scenario.actions.weather === 'show') {
                weatherPanel.classList.remove('hidden');
                setTimeout(() => {
                    weatherPanel.classList.add('hidden');
                }, 5000);
            } else if (scenario.actions.weather === 'hide') {
                weatherPanel.classList.add('hidden');
            }
            // Обновляем UI
            updateUI();
            // Добавляем в историю
            addToHistory(`Сценарий "${scenario.name}" запущен`);
        }
    }
    // Функция удаления сценария
    function deleteScenario(index) {
        const scenarios = loadScenarios();
        scenarios.splice(index, 1);
        saveScenarios(scenarios);
        renderScenarioList(scenarios);
    }
    // Обработчик для кнопки сохранения сценария
    saveScenarioBtn.addEventListener('click', () => {
        const nameInput = $('#scenario-name');
        const name = nameInput.value.trim();
        if (!name) {
            alert('Пожалуйста, введите название сценария.');
            return;
        }
        const actions = {
            curtains: $('#device-curtains').value,
            lights: $('#device-lights').value,
            tv: $('#device-tv').value,
            clock: $('#device-clock').value,
            weather: $('#device-weather').value
        };
        const scenarios = loadScenarios();
        scenarios.push({ name, actions });
        saveScenarios(scenarios);
        // Очищаем форму
        nameInput.value = '';
        // Сбрасываем все select'ы
        const selects = $$('#scenario-form select');
        selects.forEach(select => select.value = 'on'); // Выбираем первый вариант
        // Обновляем список
        renderScenarioList(scenarios);
        addToHistory(`Сценарий "${name}" создан`);
    });
    // Инициализация истории
    loadHistory();
    // Инициализация сценариев
    loadScenarios();
  </script>
</body>
</html>